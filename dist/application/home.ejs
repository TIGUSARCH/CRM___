<!DOCTYPE html>
<html lang="en">
  <!-- [Head] start -->

  <head>
    <title>Home </title>
    <!-- [Meta] -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Able Pro is trending dashboard template made using Bootstrap 5 design framework. Able Pro is available in Bootstrap, React, CodeIgniter, Angular,  and .net Technologies.">
    <meta name="keywords" content="Bootstrap admin template, Dashboard UI Kit, Dashboard Template, Backend Panel, react dashboard, angular dashboard">
    <meta name="author" content="Marco">

    <!-- [Favicon] icon -->
    <!-- <link rel="icon" href="../assets/images/favicon.svg" type="image/x-icon"> [Font] Family -->
<link rel="stylesheet" href="../assets/fonts/inter/inter.css" id="main-font-link" />
<!-- [Tabler Icons] https://tablericons.com -->
<link rel="stylesheet" href="../assets/fonts/tabler-icons.min.css" >
<!-- [Feather Icons] https://feathericons.com -->
<link rel="stylesheet" href="../assets/fonts/feather.css" >
<!-- [Font Awesome Icons] https://fontawesome.com/icons -->
<link rel="stylesheet" href="../assets/fonts/fontawesome.css" >
<!-- [Material Icons] https://fonts.google.com/icons -->
<link rel="stylesheet" href="../assets/fonts/material.css" >
<!-- [Template CSS Files] -->
<link rel="stylesheet" href="../assets/css/style.css" id="main-style-link" >
<link rel="stylesheet" href="../assets/css/style-preset.css" >
 <!-- FullCalendar CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-14K1GBX9FG"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>

<!-- <script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-14K1GBX9FG');
</script> -->
<!-- WiserNotify -->
<!-- <script>
  !(function () {
    if (window.t4hto4) console.log('WiserNotify pixel installed multiple time in this page');
    else {
      window.t4hto4 = !0;
      var t = document,
        e = window,
        n = function () {
          var e = t.createElement('script');
          (e.type = 'text/javascript'),
            (e.async = !0),
            (e.src = 'https://pt.wisernotify.com/pixel.js?ti=1jclj6jkfc4hhry'),
            document.body.appendChild(e);
        };
      'complete' === t.readyState ? n() : window.attachEvent ? e.attachEvent('onload', n) : e.addEventListener('load', n, !1);
    }
  })();
</script> -->
<!-- Microsoft clarity -->
<!-- <script type="text/javascript">
  (function (c, l, a, r, i, t, y) {
    c[a] =
      c[a] ||
      function () {
        (c[a].q = c[a].q || []).push(arguments);
      };
    t = l.createElement(r);
    t.async = 1;
    t.src = 'https://www.clarity.ms/tag/' + i;
    y = l.getElementsByTagName(r)[0];
    y.parentNode.insertBefore(t, y);
  })(window, document, 'clarity', 'script', 'gkn6wuhrtb');
</script> -->

  </head>
  <!-- [Head] end -->
  <!-- [Body] Start -->

  <body data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" data-pc-theme_contrast="" data-pc-theme="light">
    <!-- [ Pre-loader ] start -->
<div class="loader-bg">
  <div class="loader-track">
    <div class="loader-fill"></div>
  </div>
</div>
<!-- [ Pre-loader ] End -->
 <!-- [ Sidebar Menu ] start -->
 <%- include('navbar')%>


<!-- [ Sidebar Menu ] end --> <!-- [ Header Topbar ] start -->
<%- include('header')%>
<!-- [ Header ] end -->



    <!-- [ Main Content ] start -->
    <div class="pc-container">
      <div class="pc-content">
        <!-- [ breadcrumb ] start -->
        <div class="page-header">
          <div class="page-block">
            <div class="row align-items-center">
              <div class="col-md-12">
                <ul class="breadcrumb">
                  <li class="breadcrumb-item"><a href="../dashboard">Home</a></li>
                  <li class="breadcrumb-item"><a href="javascript: void(0)">Dashboard</a></li>
                  <li class="breadcrumb-item" aria-current="page">Gestión de eventos</li>
                </ul>
              </div>
              <div class="col-md-12">
                <div class="page-header-title">
                  <h2 class="mb-0">Gestión de Citas</h2>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- [ breadcrumb ] end -->
        <style>
          /* Estilos generales */
        .card {
            border: none;
            border-radius: 8px;
        }

        .card-body {
            padding: 10px;
        }

        .card-footer {
            border-top: none;
        }

        .nav-tabs .nav-link {
            border: none;
        }

        .nav-tabs .nav-link.active {
            border: none;
        }

        .dropdown-menu {
            border: none;
        }

        .dropdown-item {
            border: none;
        }

        /* Estilos para el Timeline */
        .timeline-container {
            padding: 20px;
            margin-top: 20px;
            position: relative;
        }

        .timeline {
            display: flex;
            flex-direction: column;
            gap: 18px;
            position: relative;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 50px;
            width: 2px;
            background-color: #ccc; /* Línea del cronograma */
            top: 0;
            bottom: 0;
        }

        .timeline-item {
            position: relative;
            padding-left: 90px;
        }

        .timeline-date {
            position: absolute;
            left: 0;
            top: 0;
            font-size: 0.9em;
            text-align: right;
            width: 70px;
            margin-top: 5px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 40px;
            top: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            
        }

        .timeline-content {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            
        }

        .event-checkbox {
            margin-right: 10px;
        }

        .event-details {
            flex: 1;
        }

        .event-details h5 {
            margin: 0;
        }

        .event-details p {
            margin: 5px 0 0;
        }

        </style>
        <!-- [ Main Content ] start -->
        <div class="row">





            <!-- [ Sección de Tareas ] -->

            <!-- Sección de Citas -->
            <div class="col-sm-12">
              <div class="card table-card">
                <div class="card-body">
                  <div class="text-end p-4 pb-sm-2">
              
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrearCita">+ Nueva Cita</button>
          </div>
          <table class="table-responsive">
              <thead class="table table-hover">
              <tr>
                  <th scope="col">Nombre</th>
                  <th scope="col">Descripción</th>
                  <th scope="col">Fecha</th>
                  <th scope="col">Hora Inicio</th>
                  <th scope="col">Hora Fin</th>
                  <th scope="col">Lugar</th>
                  <th scope="col">Estado</th>
                  <th scope="col">Usuario</th>
                  <th scope="col">Cliente</th>
                  <th scope="col" class="text-center">Acciones</th>
              </tr>
              </thead>
              <tbody id="lista-citas">
              <!-- Las citas se agregarán aquí dinámicamente -->
              </tbody>
          </table>
      </div>
  </div>
</div>

<!-- Modal para ver detalles de la cita -->
<div class="modal fade" id="modalDetallesCita" tabindex="-1" aria-labelledby="modalDetallesCitaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="modalDetallesCitaLabel">Detalles de la Cita</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
              <p><strong>Nombre:</strong> <span id="detalles-cita-nombre"></span></p>
              <p><strong>Descripción:</strong> <span id="detalles-cita-descripcion"></span></p>
              <p><strong>Fecha:</strong> <span id="detalles-cita-fecha"></span></p>
              <p><strong>Hora Inicio:</strong> <span id="detalles-cita-hora-inicio"></span></p>
              <p><strong>Hora Fin:</strong> <span id="detalles-cita-hora-fin"></span></p>
              <p><strong>Lugar:</strong> <span id="detalles-cita-lugar"></span></p>
              <p><strong>Estado:</strong> <span id="detalles-cita-estado"></span></p>
              <p><strong>Usuario:</strong> <span id="detalles-cita-usuario"></span></p>
              <p><strong>Cliente:</strong> <span id="detalles-cita-cliente"></span></p>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
      </div>
  </div>
</div>

<!-- Modal para editar detalles de la cita -->
<div class="modal fade" id="modalEditarCita" tabindex="-1" aria-labelledby="modalEditarCitaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="modalEditarCitaLabel">Editar Cita</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
              <form id="formEditarCita">
                  <div class="mb-3">
                      <label for="editar-cita-nombre" class="form-label">Nombre</label>
                      <input type="text" class="form-control" id="editar-cita-nombre" name="nombre" required>
                  </div>
                  <div class="mb-3">
                      <label for="editar-cita-descripcion" class="form-label">Descripción</label>
                      <textarea class="form-control" id="editar-cita-descripcion" name="descripcion" rows="3"></textarea>
                  </div>
                  <div class="mb-3">
                      <label for="editar-cita-fecha" class="form-label">Fecha</label>
                      <input type="date" class="form-control" id="editar-cita-fecha" name="fecha" required>
                  </div>
                  <div class="mb-3">
                      <label for="editar-cita-hora-inicio" class="form-label">Hora Inicio</label>
                      <input type="time" class="form-control" id="editar-cita-hora-inicio" name="horaInicio" required>
                  </div>
                  <div class="mb-3">
                      <label for="editar-cita-hora-fin" class="form-label">Hora Fin</label>
                      <input type="time" class="form-control" id="editar-cita-hora-fin" name="horaFin" required>
                  </div>
                  <div class="mb-3">
                      <label for="editar-cita-lugar" class="form-label">Lugar</label>
                      <input type="text" class="form-control" id="editar-cita-lugar" name="lugar" required>
                  </div>
                  <div class="mb-3">
                      <label for="editar-cita-estado" class="form-label">Estado</label>
                      <select class="form-control" id="editar-cita-estado" name="estado" required>
                          <option value="pendiente">Pendiente</option>
                          <option value="confirmada">Confirmada</option>
                          <option value="cancelada">Cancelada</option>
                      </select>
                  </div>
                  <div class="mb-3">
                    <label for="editar-cita-estado" class="form-label">Tipo</label>
                    <select class="form-control" id="editar-cita-tipo" name="estado" required>
                        <option value="info">Reunion</option>
                        <option value="warning">Cita</option>
                        <option value="danger">Horario Inhabilitado</option>
                    </select>
                </div>
                  <div class="mb-3">
                      <label for="editar-cita-enlace" class="form-label">Enlace</label>
                      <input type="text" class="form-control" id="editar-cita-enlace" name="enlace">
                  </div>
                  <div class="mb-3">
                      <label for="editar-cita-documentos" class="form-label">Documentos</label>
                      <input type="text" class="form-control" id="editar-cita-documentos" name="documentos">
                  </div>
                  <div class="mb-3">
                      <label for="editar-cita-usuario" class="form-label">Usuario</label>
                      <select class="form-control" id="editar-cita-usuario" name="usuarioId" required></select>
                  </div>
                  <div class="mb-3">
                      <label for="editar-cita-cliente" class="form-label">Cliente</label>
                      <select class="form-control" id="editar-cita-cliente" name="clienteId" required></select>
                  </div>
                  <input type="hidden" id="editar-cita-id">
              </form>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="guardarCambiosEditarCita">Guardar Cambios</button>
          </div>
      </div>
  </div>
</div>

<!-- Modal para crear nueva cita -->
<div class="modal fade" id="modalCrearCita" tabindex="-1" aria-labelledby="modalCrearCitaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="modalCrearCitaLabel">Crear Nueva Cita</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
              <form id="formCrearCita">
                  <div class="mb-3">
                      <label for="crear-cita-nombre" class="form-label">Nombre</label>
                      <input type="text" class="form-control" id="crear-cita-nombre" name="nombre" required>
                  </div>
                  <div class="mb-3">
                      <label for="crear-cita-descripcion" class="form-label">Descripción</label>
                      <textarea class="form-control" id="crear-cita-descripcion" name="descripcion" rows="3"></textarea>
                  </div>
                  <div class="mb-3">
                      <label for="crear-cita-fecha" class="form-label">Fecha</label>
                      <input type="date" class="form-control" id="crear-cita-fecha" name="fecha" required>
                  </div>
                  <div class="mb-3">
                      <label for="crear-cita-hora-inicio" class="form-label">Hora Inicio</label>
                      <input type="time" class="form-control" id="crear-cita-hora-inicio" name="horaInicio" required>
                  </div>
                  <div class="mb-3">
                      <label for="crear-cita-hora-fin" class="form-label">Hora Fin</label>
                      <input type="time" class="form-control" id="crear-cita-hora-fin" name="horaFin" required>
                  </div>
                  <div class="mb-3">
                      <label for="crear-cita-lugar" class="form-label">Lugar</label>
                      <input type="text" class="form-control" id="crear-cita-lugar" name="lugar" required>
                  </div>
                  <div class="mb-3">
                      <label for="crear-cita-estado" class="form-label">Estado</label>
                      <select class="form-control" id="crear-cita-estado" name="estado" required>
                          <option value="pendiente">Pendiente</option>
                          <option value="confirmada">Confirmada</option>
                          <option value="cancelada">Cancelada</option>
                      </select>
                  </div>
                  <div class="mb-3">
                    <label for="crear-cita-estado" class="form-label">Tipo</label>
                    <select class="form-control" id="crear-cita-tipo" name="estado" required>
                        <option value="info">Reunion</option>
                        <option value="warning">Cita</option>
                        <option value="danger">Horario Inhabilitado</option>
                    </select>
                </div>
                  <div class="mb-3">
                      <label for="crear-cita-enlace" class="form-label">Enlace</label>
                      <input type="text" class="form-control" id="crear-cita-enlace" name="enlace">
                  </div>
                  <div class="mb-3">
                      <label for="crear-cita-documentos" class="form-label">Documentos</label>
                      <input type="text" class="form-control" id="crear-cita-documentos" name="documentos">
                  </div>
                  <div class="mb-3">
                      <label for="crear-cita-usuario" class="form-label">Usuario</label>
                      <select class="form-control" id="crear-cita-usuario" name="usuarioId" required></select>
                  </div>
                  <div class="mb-3">
                      <label for="crear-cita-cliente" class="form-label">Cliente</label>
                      <select class="form-control" id="crear-cita-cliente" name="clienteId" required></select>
                  </div>
              </form>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="botonCrearCita">Crear Cita</button>
          </div>
      </div>
  </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', (event) => {
  const socket = io();

  const cargarCitas = () => {
      fetch('/citas')
          .then(response => response.json())
          .then(citas => {
              renderizarCitas(citas);
          })
          .catch(error => {
              console.error('Error al cargar las citas:', error);
          });
  };

  const cargarUsuariosYClientesEnSelect = async () => {
      const usuariosResponse = await fetch('/usuarios');
      const clientesResponse = await fetch('/clientes');

      const usuarios = await usuariosResponse.json();
      const clientes = await clientesResponse.json();

      const selectUsuario = document.getElementById('crear-cita-usuario');
      const selectCliente = document.getElementById('crear-cita-cliente');


      usuarios.data.forEach(usuario => {
          const option = document.createElement('option');
          option.value = usuario.id;
          option.textContent = `${usuario.nombre} ${usuario.apellidoPaterno} ${usuario.apellidoMaterno}`;
          selectUsuario.appendChild(option);
      });

      clientes.data.forEach(cliente => {
          const option = document.createElement('option');
          option.value = cliente.id;
          option.textContent = `${cliente.nombre} ${cliente.apellidoPaterno} ${cliente.apellidoMaterno}`;
          selectCliente.appendChild(option);
      });
  };

  
  const cargarUsuariosYClientesEnSelectE = async () => {
    const usuariosResponse = await fetch('/usuarios');
    const clientesResponse = await fetch('/clientes');

    const usuarios = await usuariosResponse.json();
    const clientes = await clientesResponse.json();

    const selectUsuarioE = document.getElementById('editar-cita-usuario');
    const selectClienteE = document.getElementById('editar-cita-cliente');

    usuarios.data.forEach(usuario => {
        const option = document.createElement('option');
        option.value = usuario.id;
        option.textContent = `${usuario.nombre} ${usuario.apellidoPaterno} ${usuario.apellidoMaterno}`;
        selectUsuarioE.appendChild(option);
    });

    clientes.data.forEach(cliente => {
        const option = document.createElement('option');
        option.value = cliente.id;
        option.textContent = `${cliente.nombre} ${cliente.apellidoPaterno} ${cliente.apellidoMaterno}`;
        selectClienteE.appendChild(option);
    });
};

  const formatearHora12Horas = (hora) => {
      const [hora24, minutos] = hora.split(':');
      const hora12 = hora24 % 12 || 12;
      const amPm = hora24 >= 12 ? 'PM' : 'AM';
      return `${hora12}:${minutos} ${amPm}`;
  };

  const renderizarCitas = (citas) => {
      const listaCitas = document.getElementById('lista-citas');
      listaCitas.innerHTML = '';

      citas.forEach(cita => {
          const fila = document.createElement('tr');
          fila.setAttribute('data-id', cita.id);
          fila.innerHTML = `
              <td>${cita.nombre}</td>
              <td>${cita.descripcion}</td>
              <td>${cita.fecha}</td>
              <td>${formatearHora12Horas(cita.horaInicio)}</td>
              <td>${formatearHora12Horas(cita.horaFin)}</td>
              <td>${cita.lugar}</td>
              <td>${cita.estado}</td>
              <td>${cita.Usuario ? `${cita.Usuario.nombre} ${cita.Usuario.apellidoPaterno} ${cita.Usuario.apellidoMaterno}` : 'Desconocido'}</td>
              <td>${cita.Cliente ? `${cita.Cliente.nombre} ${cita.Cliente.apellidoPaterno} ${cita.Cliente.apellidoMaterno}` : 'Desconocido'}</td>
              <td class="text-center">
                  <ul class="list-inline mb-0">
                      <li class="list-inline-item" data-bs-toggle="tooltip" title="Ver">
                          <a href="#" class="avtar avtar-xs btn-link-secondary btn-pc-default detalle-cita-enlace" data-cita-id="${cita.id}">
                              <i class="ti ti-eye f-18"></i>
                          </a>
                      </li>
                      <li class="list-inline-item" data-bs-toggle="tooltip" title="Editar">
                          <a href="#" class="avtar avtar-xs btn-link-success btn-pc-default editar-cita-enlace" data-cita-id="${cita.id}">
                              <i class="ti ti-edit-circle f-18"></i>
                          </a>
                      </li>
                      <li class="list-inline-item" data-bs-toggle="tooltip" title="Eliminar">
                          <a href="#" class="avtar avtar-xs btn-link-danger btn-pc-default eliminar-cita" data-cita-id="${cita.id}">
                              <i class="ti ti-trash f-18"></i>
                          </a>
                      </li>
                  </ul>
              </td>
          `;

          listaCitas.appendChild(fila);

          fila.querySelectorAll('.detalle-cita-enlace').forEach(element => {
              element.addEventListener('click', (e) => {
                  e.preventDefault();
                  mostrarDetallesCita(cita);
              });
          });

          fila.querySelector('.editar-cita-enlace').addEventListener('click', async (e) => {
              e.preventDefault();
              await mostrarEditarCita(cita);
          });

          fila.querySelector('.eliminar-cita').addEventListener('click', (e) => {
              e.preventDefault();
              eliminarCita(cita.id);
          });
      });
  };

  const mostrarDetallesCita = (cita) => {
      document.getElementById('detalles-cita-nombre').textContent = cita.nombre;
      document.getElementById('detalles-cita-descripcion').textContent = cita.descripcion;
      document.getElementById('detalles-cita-fecha').textContent = cita.fecha;
      document.getElementById('detalles-cita-hora-inicio').textContent = formatearHora12Horas(cita.horaInicio);
      document.getElementById('detalles-cita-hora-fin').textContent = formatearHora12Horas(cita.horaFin);
      document.getElementById('detalles-cita-lugar').textContent = cita.lugar;
      document.getElementById('detalles-cita-estado').textContent = cita.estado;
      document.getElementById('detalles-cita-usuario').textContent = cita.Usuario ? `${cita.Usuario.nombre} ${cita.Usuario.apellidoPaterno} ${cita.Usuario.apellidoMaterno}` : 'Desconocido';
      document.getElementById('detalles-cita-cliente').textContent = cita.Cliente ? `${cita.Cliente.nombre} ${cita.Cliente.apellidoPaterno} ${cita.Cliente.apellidoMaterno}` : 'Desconocido';

      const detallesCitaModal = new bootstrap.Modal(document.getElementById('modalDetallesCita'));
      detallesCitaModal.show();
  };

  const mostrarEditarCita = async (cita) => {
      <!-- await cargarUsuariosYClientesEnSelect(); -->

      document.getElementById('editar-cita-nombre').value = cita.nombre;
      document.getElementById('editar-cita-descripcion').value = cita.descripcion;
      document.getElementById('editar-cita-fecha').value = cita.fecha;
      document.getElementById('editar-cita-hora-inicio').value = cita.horaInicio;
      document.getElementById('editar-cita-hora-fin').value = cita.horaFin;
      document.getElementById('editar-cita-lugar').value = cita.lugar;
      document.getElementById('editar-cita-estado').value = cita.estado;
      document.getElementById('editar-cita-tipo').value = cita.tipoCita;
      document.getElementById('editar-cita-enlace').value = cita.enlace;
      document.getElementById('editar-cita-documentos').value = cita.documentos;
      document.getElementById('editar-cita-usuario').value = cita.usuarioId;
      document.getElementById('editar-cita-cliente').value = cita.clienteId;
      document.getElementById('editar-cita-id').value = cita.id;

      const editarCitaModal = new bootstrap.Modal(document.getElementById('modalEditarCita'));
      editarCitaModal.show();
  };

  const eliminarCita = (id) => {
      if (confirm('¿Estás seguro de que deseas eliminar esta cita?')) {
          fetch(`/citas/${id}`, { method: 'DELETE' })
              .then(response => {
                  if (response.ok) {
                      socket.emit('obtenerCitas');
                  } else {
                      alert('Error al eliminar la cita.');
                  }
              })
              .catch(error => {
                  console.error('Error al eliminar la cita:', error);
              });
      }
  };

  document.querySelector('[data-bs-target="#modalCrearCita"]').addEventListener('click', async () => {
      await cargarUsuariosYClientesEnSelect();
  });

  document.getElementById('botonCrearCita').addEventListener('click', () => {

      const fecha= document.getElementById('crear-cita-fecha').value
      var fechaFormateada = moment(fecha).format('YYYY-MM-DD HH:mm:ssZ');
      const horaInicio= document.getElementById('crear-cita-hora-inicio').value
      var FH1= fecha+'T'+horaInicio
      var momento = moment(FH1).utcOffset('-06:00');
      var horaFormateada = momento.format('YYYY-MM-DD HH:mm:ssZ');
      const horaFin= document.getElementById('crear-cita-hora-fin').value
      var FH2= fecha+'T'+horaFin
      var momento2 = moment(FH2).utcOffset('-06:00');
      var horaFormateada2 = momento2.format('YYYY-MM-DD HH:mm:ssZ');
      const tipoCita = document.getElementById('crear-cita-tipo').value
      const nuevaCita = {
          nombre: document.getElementById('crear-cita-nombre').value,
          descripcion: document.getElementById('crear-cita-descripcion').value,
          fecha: fechaFormateada,
          horaInicio: horaFormateada,
          horaFin: horaFormateada2,
          tipoCita: tipoCita,
          lugar: document.getElementById('crear-cita-lugar').value,
          estado: document.getElementById('crear-cita-estado').value,
          enlace: document.getElementById('crear-cita-enlace').value,
          documentos: document.getElementById('crear-cita-documentos').value,
          usuarioId: document.getElementById('crear-cita-usuario').value,
          clienteId: document.getElementById('crear-cita-cliente').value
      };
      console.log(nuevaCita)
      fetch('/citas', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(nuevaCita)
      })
      .then(response => response.json())
      .then(cita => {
          if (cita) {
              socket.emit('obtenerCitas');
              cerrarModal('modalCrearCita');
          } else {
              alert('Error al crear la cita.');
          }
      })
      .catch(error => {
          console.error('Error al crear la cita:', error);
      });
  });

  document.getElementById('guardarCambiosEditarCita').addEventListener('click', () => {
        const citaId = document.getElementById('editar-cita-id').value;
        const fecha= document.getElementById('editar-cita-fecha').value
        var fechaFormateada = moment(fecha).format('YYYY-MM-DD HH:mm:ssZ');
        const horaInicio= document.getElementById('editar-cita-hora-inicio').value
        var FH1= fecha+'T'+horaInicio
        var momento = moment(FH1).utcOffset('-06:00');
        var horaFormateada = momento.format('YYYY-MM-DD HH:mm:ssZ');
        const horaFin= document.getElementById('editar-cita-hora-fin').value
        var FH2= fecha+'T'+horaFin
        var momento2 = moment(FH2).utcOffset('-06:00');
        var horaFormateada2 = momento2.format('YYYY-MM-DD HH:mm:ssZ');
        const tipoCita = document.getElementById('editar-cita-tipo').value
      const citaActualizada = {
          nombre: document.getElementById('editar-cita-nombre').value,
          descripcion: document.getElementById('editar-cita-descripcion').value,
          fecha: fechaFormateada,
          horaInicio: horaFormateada,
          horaFin: horaFormateada2,
          lugar: document.getElementById('editar-cita-lugar').value,
          estado: document.getElementById('editar-cita-estado').value,
          tipoCita: tipoCita,
          enlace: document.getElementById('editar-cita-enlace').value,
          documentos: document.getElementById('editar-cita-documentos').value,
          usuarioId: document.getElementById('editar-cita-usuario').value,
          clienteId: document.getElementById('editar-cita-cliente').value
      };

      fetch(`/citas/${citaId}`, {
          method: 'PUT',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(citaActualizada)
      })
      .then(response => {
          if (response.ok) {
              socket.emit('obtenerCitas');
              cerrarModal('modalEditarCita');
          } else {
              alert('Error al actualizar la cita.');
          }
      })
      .catch(error => {
          console.error('Error al actualizar la cita:', error);
      });
  });

  const cerrarModal = (modalId) => {
      const modalElement = document.getElementById(modalId);
      const modalInstance = bootstrap.Modal.getInstance(modalElement);
      modalInstance.hide();
  };

  socket.on('connect', () => {
      console.log('Conectado al servidor con ID:', socket.id);
  });

  socket.on('disconnect', () => {
      console.log('Desconectado del servidor');
  });

  socket.on('citas', (citas) => {
      renderizarCitas(citas);
  });

  socket.on('citaCreada', (cita) => {
      cargarCitas();
  });

  socket.on('citaActualizada', (cita) => {
      cargarCitas();
  });

  socket.on('citaEliminada', ({ id }) => {
      cargarCitas();
  });

  cargarCitas();
});
</script>

      

            <!-- [ Fin Sección de tareas ] -->





            

            <%- include('footer')%>
        </div>
        <!-- [ Main Content ] end -->
      </div>
    </div>
    <!-- [ Main Content ] end -->

    <!-- [Page Specific JS] start -->
    <script src="../assets/js/plugins/apexcharts.min.js"></script>
    <script src="../assets/js/pages/dashboard-default.js"></script>
    <!-- [Page Specific JS] end -->
    <!-- Required Js -->
    <script src="../assets/js/plugins/popper.min.js"></script>
    <script src="../assets/js/plugins/simplebar.min.js"></script>
    <script src="../assets/js/plugins/bootstrap.min.js"></script>
    <script src="../assets/js/fonts/custom-font.js"></script>
    <script src="../assets/js/pcoded.js"></script>
    <script src="../assets/js/plugins/feather.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0/js/bootstrap.bundle.min.js"></script>
    
    
    
    
    <script>layout_change_default();</script>
    
    
    
    
    <script>layout_theme_contrast_change('false');</script>
    
    
    
    <script>change_box_container('false');</script>
    
    
    <script>layout_caption_change('true');</script>
    
    
    
    
    <script>layout_rtl_change('false');</script>
    
    
    <script>preset_change("preset-9");</script>

      <!-- [Page Specific JS] start -->
  <!-- calender js -->
  <script src="../assets/js/plugins/index.global.min.js"></script>
  <!-- Sweet Alert -->
  <script src="../assets/js/plugins/sweetalert2.all.min.js"></script>
  <script src="../assets/js/pages/calendar.js"></script>
  <script src="../assets/js/form-handler.js"></script>
  <!-- [Page Specific JS] end -->
  <!-- <script src="../funcionesCitas.js"></script> -->
    
  </body>
  <!-- [Body] end -->
</html>
